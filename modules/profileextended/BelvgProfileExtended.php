<?php/** 2007-2012 PrestaShop ** NOTICE OF LICENSE** This source file is subject to the Academic Free License (AFL 3.0)* that is bundled with this package in the file LICENSE.txt.* It is also available through the world-wide-web at this URL:* http://opensource.org/licenses/afl-3.0.php* If you did not receive a copy of the license and are unable to* obtain it through the world-wide-web, please send an email* to license@prestashop.com so we can send you a copy immediately.**         DISCLAIMER   ** *************************************** *//* Do not edit or add to this file if you wish to upgrade Prestashop to newer* versions in the future.* ***************************************************** @category   Belvg* @package    Belvg_UserProfileExtended* @copyright  Copyright (c) 2010 - 2012 BelVG LLC. (http://www.belvg.com)* @license    http://store.belvg.com/BelVG-LICENSE-COMMUNITY.txt*///error_reporting(E_ALL | E_STRICT);require_once dirname(__FILE__) . '/../../config/autoload.php';class BelVG extends ObjectModel{	public static function l($string)	{		return strip_tags($string);	}		public static function getAttribute($attribute, $id_customer, $width, $height)	{		$entity = Db::getInstance()->getRow('SELECT e.value, a.type, a.system, a.title											  FROM '._DB_PREFIX_.'belvg_customerprofile_entity as e, '._DB_PREFIX_.'belvg_customerprofile_attributes as a											  WHERE e.attribute_id = a.attribute_id AND a.system = "'.$attribute.'" AND e.customer_id = ' . $id_customer);		$value = '';		switch ($entity['type']){			case 'text':				$value = $entity['value'];			break;			case 'file':				$value = '<a href="' . __PS_BASE_URI__ . 'upload/profile_extended/' . $entity['system'] . '/' . $entity['value'] . '">'.$entity['title'].'</a>';			break;			case 'image':				$value = '<img width="'.$width.'" height="'.$height.'" src="'. __PS_BASE_URI__ . 'upload/profile_extended/' . $entity['system'] . '/' . $entity['value'] . '" title="'.$entity['title'].'">';			break;			case 'select':				$value = $entity['value'];			break;						case 'multiselect':				if (count(explode('{|}', $entity['value']))>1)					$value = '<ol><li>'.str_replace('{|}', '</li><li>', $entity['value']).'</li></ol>';				else					$value = $entity['value'];			break;		}		return $value;	}		public static function sendMessage($id_customer, $title, $message, $type, $tmp_file = array())	{	//echo substr(strtolower($tmp_file['name']), -4); die;		$err = true;		$file_name = '';		if ($tmp_file['error'] == '0' && substr(strtolower($tmp_file['name']), -4) == '.zip')		{			$file_name = md5(microtime()).'.zip';			if (!@copy($tmp_file['tmp_name'], dirname(dirname(dirname(__FILE__))) . '/upload/profile_extended/messages/' . $file_name))			{				$file_name = '';				$err = false;			}		}				$mess = '';		if ($type != 1) $mess = addslashes(strip_tags($message)); 		else $mess = addslashes($message);				if (isset($_POST['id']) && (int)$_POST['id'] > 0)			Db::getInstance()->Execute('UPDATE '._DB_PREFIX_.'belvg_customerprofile_messages SET title = "'.addslashes(strip_tags($title)).'", message = "'.$mess.'"									WHERE id = ' . (int)$_POST['id']);		else			Db::getInstance()->Execute('INSERT INTO '._DB_PREFIX_.'belvg_customerprofile_messages 									VALUES(NULL, '.$id_customer.', NOW(), "'.addslashes(strip_tags($title)).'", "'.$mess.'", 1, '.(int)$type.', 0, "'.$file_name.'")');		return $err;	}		public static function deleteMessage($id_message, $id_customer)	{		$file = Db::getInstance()->getValue('SELECT file FROM '._DB_PREFIX_.'belvg_customerprofile_messages WHERE id = ' .$id_message. ' AND customer_id = ' . $id_customer);		if (!empty($file))			@unlink(dirname(dirname(dirname(__FILE__))) . '/upload/profile_extended/messages/' . $file);					Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_messages WHERE id = ' .$id_message. ' AND customer_id = ' . $id_customer);	}		public static function enableMessage($id_message, $id_customer)	{		Db::getInstance()->Execute('UPDATE '._DB_PREFIX_.'belvg_customerprofile_messages SET enable = 1 WHERE id = ' .$id_message. ' AND customer_id = ' . $id_customer);	}			public static function getCustomers($id){		$row = array();		$valid_id = intval($id);		if ($valid_id > 0)			$row = Db::getInstance()->getRow('			SELECT *			FROM `'._DB_PREFIX_.'customer`			WHERE `id_customer` = "'. $valid_id .'"');		else		{			$order = ' firstname ASC, lastname ASC ';						$row = Db::getInstance()->ExecuteS('			SELECT *			FROM `'._DB_PREFIX_.'customer` ORDER BY ' . $order);		}		return $row;	}				public static function deleteAttribute($attribute_id)	{			Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_values WHERE attribute_id = ' . $attribute_id);			Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE attribute_id = ' . $attribute_id);		}	public static function deleteAttributeValues($value_id, $customer_id)	{			$entity = Db::getInstance()->getRow('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_entity WHERE id = ' . $value_id);			$system = Db::getInstance()->getValue('SELECT system FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE attribute_id = ' . $entity['attribute_id']);			Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_entity WHERE id = ' . $value_id . ' AND customer_id = ' . $customer_id);				@unlink(dirname(dirname(dirname(__FILE__))) . '/upload/profile_extended/' .$system. '/' . $entity['value']);	}		public static function saveAttributeValues($post, $files, $id_customer)	{		$error = 0;		Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_entity WHERE attribute_id = (SELECT attribute_id FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE type = "multiselect")');		foreach ($post['attr'] as $key=>$attributes){			foreach ($attributes as $id_attribute=>$values){				Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_entity WHERE attribute_id = '.$id_attribute.' AND customer_id = '.$id_customer );				if ($key == 'multiselect'){					$value = implode('{|}', $values);				} else $value = $values;				Db::getInstance()->Execute('INSERT INTO '._DB_PREFIX_.'belvg_customerprofile_entity VALUES(NULL, "'.$id_attribute.'", "'.$id_customer.'", "'.$value.'")');			}		}		foreach ($files['attr']['tmp_name'] as $key=>$attributes){			foreach ($attributes as $id_attribute=>$value){				if (empty($value)) continue;				if ($key == 'file'){					if (substr(strtolower($files['attr']['name']['file'][$id_attribute]), -4) != '.zip' || 						(int)$files['attr']['error']['file'][$id_attribute] > 0) {$error++; continue;}					$file_name = md5(microtime()).'.zip';				}				if ($key == 'image'){					$type = '';					switch ($files['attr']['type']['image'][$id_attribute]){						case 'image/jpeg':							$type = '.jpg';						break;						case 'image/pjpeg':							$type = '.jpg';						break;						case 'image/gif':							$type = '.gif';						break;						case 'image/png':							$type = '.png';						break;						default: $type = ''; break;					}					if ((int)$files['attr']['error']['image'][$id_attribute] > 0 || empty($type)) {$error++; continue;}										$file_name = md5(microtime()).$type;				}				Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_entity WHERE attribute_id = '.$id_attribute.' AND customer_id = '.$id_customer );				$system = Db::getInstance()->getValue('SELECT system FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE attribute_id = '.$id_attribute);				if (!@copy($value, dirname(dirname(dirname(__FILE__))) . '/upload/profile_extended/' .$system. '/' . $file_name)) { $error++; continue;}				Db::getInstance()->Execute('INSERT INTO '._DB_PREFIX_.'belvg_customerprofile_entity VALUES(NULL, "'.$id_attribute.'", "'.$id_customer.'", "'.$file_name.'")');			}		}		if ($error  == 0) 			return 0;		else 			return $error;	}		public static function getAttributeValuesForm($id_customer, $url, $img_dir, $is_back)	{			$customer = Db::getInstance()->getRow('SELECT * FROM '._DB_PREFIX_.'customer WHERE id_customer = ' . $id_customer);			$output = '				<h3>'.self::l('First name').': '.$customer['firstname'].'</h3>				<h3>'.self::l('Last name').': '.$customer['lastname'].'</h3>				<h3>'.self::l('E-mail').': '.$customer['email'].'</h3>				<form action="'.$url.'" method="post" autocomplete="off" class="std" enctype="multipart/form-data">					<input type="hidden" name="id" value="'.$customer['id_customer'].'">					<input type="hidden" name="action" value="save">			';				$groups = Db::getInstance()->ExecuteS('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_groups WHERE enable = 0 ORDER BY sort_order ASC');				foreach ($groups as $group){					$output .= '						<fieldset>							<legend>								'.$group['title'].'							</legend>							';							$attributes = Db::getInstance()->ExecuteS('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE group_id = ' . $group['group_id'] . ' AND enable = 0 ORDER BY sort_order ASC');							foreach ($attributes as $attribute){								$enti = Db::getInstance()->getRow('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_entity WHERE attribute_id = ' . $attribute['attribute_id'] . ' AND customer_id = ' . $customer['id_customer']);								$entity = $enti['value'];								$output .= '									<p class="text">									<label><b>'.$attribute['title'].' '.($attribute['type'] == 'file' ? ' (*.zip)' : ($attribute['type'] == 'image' ? ' (*.jpg, *.png, *.gif)' : '')).':</b> </label>									';																			switch ($attribute['type']){										case 'text': 											$output .= '<input type="text" size="27" name="attr[text]['.$attribute['attribute_id'].']" value="'.$entity.'">'; 										break;										case 'textarea': 											$output .= '<textarea name="attr[textarea]['.$attribute['attribute_id'].']" style="width:340px; height:160px;">'.$entity.'</textarea>'; 										break;																				case 'file':											$output .= '<b id="frm-file'.$attribute['attribute_id'].'"><input type="file" name="attr[file]['.$attribute['attribute_id'].']"></b><a href="javascript:;" onclick="jQuery(\'#frm-file'.$attribute['attribute_id'].'\').html(\'<input type=file name=attr[file]['.$attribute['attribute_id'].'] >\')"><img src="'.$img_dir.'disabled.gif"></a>';											if (!empty($entity)) 												$output .= '<br><a style="margin-left:170px;" target="_blank" href="'.__PS_BASE_URI__.'upload/profile_extended/'.$attribute['system'].'/'.$entity.'">'.$entity.'</a>															<a onclick="if (!confirm(\'Are you sure?\')) return false" href="'.$url.'action=attr_del&id='.$enti['id'].'&customer='.$customer['id_customer'].'"><img src="'.$img_dir.'disabled.gif"></a>'; 										break;										case 'image':											$output .= '<b id="frm-image'.$attribute['attribute_id'].'"><input type="file" name="attr[image]['.$attribute['attribute_id'].']"></b><a href="javascript:;" onclick="jQuery(\'#frm-image'.$attribute['attribute_id'].'\').html(\'<input type=file name=attr[image]['.$attribute['attribute_id'].'] >\')"><img src="'.$img_dir.'disabled.gif"></a><br>'; 											if (!empty($entity)) 												$output .= '<br><img style="margin-left:170px;" width="150" src="'.__PS_BASE_URI__.'upload/profile_extended/'.$attribute['system'].'/'.$entity.'"/>															<a onclick="if (!confirm(\'Are you sure?\')) return false" href="'.$url.'action=attr_del&id='.$enti['id'].'&customer='.$customer['id_customer'].'"><img src="'.$img_dir.'disabled.gif"></a>'; 										break;										case 'select':											$select = Db::getInstance()->ExecuteS('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_values WHERE attribute_id = ' . $attribute['attribute_id']);											foreach ($select as $sel){													$output .= '<input type="radio" '.($sel['value'] == $entity ? 'checked' : '').' name="attr[select]['.$attribute['attribute_id'].']" value="'.$sel['value'].'">&nbsp;&nbsp;' . $sel['value'] . '&nbsp;&nbsp;';											}										break;										case 'multiselect':											$multi = explode('{|}', $entity);											$select = Db::getInstance()->ExecuteS('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_values WHERE attribute_id = ' . $attribute['attribute_id']);											foreach ($select as $sel){													$output .= '<input type="checkbox" '.(in_array($sel['value'], $multi) ? 'checked' : '').' name="attr[multiselect]['.$attribute['attribute_id'].']['.$sel['value_id'].']" value="'.$sel['value'].'">&nbsp;&nbsp;' . $sel['value'] . '&nbsp;&nbsp;';											}											break;																		}																		$output .= '</p>';							}										$output .= '						</fieldset>						<br>';				}			if ($is_back)			$output .= '					<input type="button" onclick="location.href=\''.$url.'\'" class="button" value=" '.self::l('Back').' ">			';			$output .= '					<input type="submit" class="button" value=" '.self::l('Save').' ">				</form>			';			return $output;	}		public static function deleteGroup($id_group)	{		$attributes = Db::getInstance()->ExecuteS('SELECT attribute_id FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE group_id = '.$id_group);		foreach ($attributes as $attribute){			Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_values WHERE attribute_id = ' . $attribute['attribute_id']);		}		Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE group_id = ' . $id_group);		Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_groups WHERE group_id = '.$id_group.';');	}		public static function editGroup()	{			if ($_POST['edit_group'] != 'new'){ 				if ($_POST['title']) Db::getInstance()->Execute('UPDATE '._DB_PREFIX_.'belvg_customerprofile_attributes_groups SET title="'.$_POST['title'].'", sort_order = "'.$_POST['sort_order'].'", enable = '.$_POST['active'].' WHERE group_id = '.(int)$_POST['edit_group'].';');			} else				if ($_POST['title']) Db::getInstance()->Execute('INSERT INTO '._DB_PREFIX_.'belvg_customerprofile_attributes_groups VALUES (NULL, "'.$_POST['title'].'", "'.$_POST['sort_order'].'", '.$_POST['active'].');');		}		public static function editAttribute($url)	{		$_POST['system'] = strtolower(transliterate($_POST['system']));			if ((int)$_POST['edit_attribute'] > 0){				Db::getInstance()->Execute('UPDATE '._DB_PREFIX_.'belvg_customerprofile_attributes SET title = "'.$_POST['title'].'", sort_order = "'.$_POST['sort_order'].'", enable = '.$_POST['enable'].' WHERE attribute_id = '.$_POST['edit_attribute']);				if ($_POST['type'] == 'select' || $_POST['type'] == 'multiselect')				foreach($_POST['option'] as $key=>$option){					if (empty($option)) Db::getInstance()->Execute('DELETE FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_values WHERE value_id = ' . $key);					if (is_array($option) && $key == 'new'){						foreach ($option as $new){							if (empty($new)) continue;							Db::getInstance()->Execute('INSERT INTO '._DB_PREFIX_.'belvg_customerprofile_attributes_values VALUES(NULL, "'.(int)$_POST['edit_attribute'].'", "'.$new.'")');						}					} else {						Db::getInstance()->Execute('UPDATE '._DB_PREFIX_.'belvg_customerprofile_attributes_values SET value = "'.$option.'" WHERE value_id = ' . $key);					}				}							} else {				$exist = Db::getInstance()->getValue('SELECT COUNT(*) FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE system = "'.$_POST['system'].'"');				if ($exist){ 					header('Location: '.$url.'&action=attr_new&id_group='.$_POST['id_group'].'&err=1');					die;				}				Db::getInstance()->Execute('INSERT INTO '._DB_PREFIX_.'belvg_customerprofile_attributes VALUES(NULL, "'.$_POST['title'].'", "'.$_POST['type'].'", "'.$_POST['id_group'].'", "'.$_POST['system'].'", "'.$_POST['sort_order'].'", '.$_POST['enable'].')');				$id_attr = mysql_insert_id();				if ($_POST['type'] == 'select' || $_POST['type'] == 'multiselect')					foreach($_POST['option']['new'] as $option){						if (empty($option)) continue;						Db::getInstance()->Execute('INSERT INTO '._DB_PREFIX_.'belvg_customerprofile_attributes_values VALUES(NULL, "'.$id_attr.'", "'.$option.'")');										}					$new_dir = dirname(dirname(dirname(__FILE__))) . '/upload/profile_extended/' . $_POST['system'];					if (@mkdir($new_dir, 0777)){						$f = fopen($new_dir . '/index.php', 'w');						fclose($f);					}							}		}		public static function getEditGroupForm($url)	{		if (!isset($_GET['id_group'])) $_GET['id_group'] = '';					$group = Db::getInstance()->getRow('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_groups WHERE group_id = '.$_GET['id_group']);			return '			<form autocomplete="off" method="post" action="'.$url.'" onsubmit="if ($(\'#title\').val() == \'\') return false">				<input type="hidden" value="'.($_GET['id_group'] ? $_GET['id_group'] : 'new').'" name="edit_group">				<fieldset>					<legend>						<img src="../img/admin/tab-customers.gif">						'.($_GET['action'] == 'new' ? self::l('Add new Group') : self::l('Edit Group')).'					</legend>					<label>'.self::l('Title').': <span style="color:red;">*</span></label>					<div class="margin-form">						<input id="title" type="text" value="'.$group['title'].'" name="title" size="50">					</div>					<label>'.self::l('Sort Order').': </label>					<div class="margin-form">						<input id="title" type="text" value="'.$group['sort_order'].'" name="sort_order" size="50">					</div>						<label>'.self::l('Active').': </label>					<div class="margin-form">						<input type="radio" '.($group['enable'] == '0' ? 'checked' : empty($group['enable']) ? 'checked' : '' ).' value="0" name="active"> Yes						<input type="radio" '.($group['enable'] == '1' ? 'checked' : '' ).' value="1" name="active"> No					</div>											<div class="margin-form space">						<input class="button" onclick="location.href=\''.$url.'\'" type="button" value=" '.self::l('Back').' ">						<input class="button" type="submit" name="submitAddcms" value=" '.self::l('Save').' ">					</div>				</fieldset>			</form>			';				}		public static function getAttributeList($id_group, $url)	{		$output = '<h3>'.self::l('Manage Attributes. Group').': '.Db::getInstance()->getValue('SELECT title FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_groups WHERE group_id = '.$id_group).'</h3>';		$attributes = Db::getInstance()->ExecuteS('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE group_id = '.$id_group);		if (count($attributes)>0){			$output .= '				<form action="" method="POST">				<input type="hidden" name="action" value="update_attr">				<input type="hidden" name="id_group" value="'.$id_group.'">				<table class="table" cellspacing="0" cellpadding="0">					<thead>						<th width="150">'.self::l('Attribute ID').'</th>						<th width="150">'.self::l('Attribute Title').'</th>						<th width="150">'.self::l('Type').'</th>						<th width="150">'.self::l('System name').'</th>						<th width="75">'.self::l('Sort Order').'</th>						<th width="75">'.self::l('Active').'</th>												<th width="150">'.self::l('Action').'</th>					</thead>					<tbody>			';				foreach ($attributes as $attribute)					$output .= '										<tr>									<td>'.$attribute['attribute_id'].'</td>									<td><a href="'.$url.'&action=attr_edit&id_attribute='.$attribute['attribute_id'].'&id_group='.$id_group.'">'.$attribute['title'].'</a></td>									<td>'.$attribute['type'].'</td>									<td>'.$attribute['system'].'</td>									<td>'.$attribute['sort_order'].'</td>									<td>'.($attribute['enable'] == '0' ? '<font color="green">Yes</green>' : '<font color="red">No</green>').'</td>									<td>										<a href="'.$url.'&action=attr_edit&id_attribute='.$attribute['attribute_id'].'&id_group='.$id_group.'">'.'<img title="Edit Attribute" alt="Edit Attribute" src="../img/admin/edit.gif"></a>										<a onclick="if (!confirm(\'Are you sure?\')) return false;" href="'.$url.'&action=delete_attr&attr_id='.$attribute['attribute_id'].'&id_group='.$_GET['id_group'].'"><img title="Delete Attribute" alt="Delete Attribute" src="../img/admin/delete.gif"></a>									</td>									</tr>					';								$output .= '					</tbody>				</table>				</form>				<br>				<input class="button" onclick="location.href=\''.$url.'\'" type="button" value=" '.self::l('Back').' ">				<input type="button" class="button" onclick="location.href=\''.$url.'&action=attr_new&id_group='.$id_group.'\'" value="'.self::l('Add new Attribute').'">						';		}			else $output .= 'No item<br><br><input class="button" onclick="location.href=\''.$url.'\'" type="submit" value=" Back ">							<input type="button" class="button" onclick="location.href=\''.$url.'&action=attr_new&id_group='.$id_group.'\'" value="'.self::l('Add new Attribute').'">';		return $output;	}		public static function getGroupList($url)	{			$groups = Db::getInstance()->ExecuteS('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_groups');			$output = '<h3>Manage Groups:</h3>				<table class="table" cellspacing="0" cellpadding="0">					<thead>						<th width="50">'.self::l('Group ID').'</th>						<th width="170">'.self::l('Group Title').'</th>						<th width="150">'.self::l('Sort Order').'</th>						<th width="150">'.self::l('Active').'</th>						<th width="80">'.self::l('Action').'</th>					</thead>					<tbody>			';				foreach ($groups as $group)					$output .= '										<tr><td>'.$group['group_id'].'</td>									<td><a href="'.$url.'&action=list_attr&id_group='.$group['group_id'].'">'.$group['title'].'</a></td>									<td>'.$group['sort_order'].'</td>									<td>'.($group['enable'] == '0' ? '<font color="green">Yes</green>' : '<font color="red">No</green>').'</td>																		<td>										<a href="'.$url.'&action=edit&id_group='.$group['group_id'].'"><img title="Edit Group" alt="Edit Group" src="../img/admin/edit.gif"></a>										<a onclick="if (!confirm(\'Are you sure?\')) return false;" href="'.$url.'&action=delete&id_group='.$group['group_id'].'"><img title="Delete Group" alt="Delete Group" src="../img/admin/delete.gif"></a>										<a href="'.$url.'&action=list_attr&id_group='.$group['group_id'].'"><img title="View Attributes this Group" alt="View" src="../img/admin/details.gif"></a>										<a href="'.$url.'&action=attr_new&id_group='.$group['group_id'].'"><img title="Add new Attribute in Group" border="0" src="../img/admin/add.gif"></a>									</td></tr>					';								$output .= '					</tbody>				</table><br>				<input type="button" class="button" onclick="location.href=\''.$url.'&action=new\'" value="'.self::l('Add new Group').'">						';			return $output;	}		public static function getAttributeForm($id_attribute, $id_group, $url)	{			$attribute = Db::getInstance()->getRow('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_attributes WHERE attribute_id = '.$id_attribute);			$options = Db::getInstance()->ExecuteS('SELECT * FROM '._DB_PREFIX_.'belvg_customerprofile_attributes_values WHERE attribute_id = '.$id_attribute);			$output = '';			if (isset($_GET['err']) && $_GET['err'] == '1') 				$output .= '<div class="error">								<img src="../img/admin/error2.png">									Error								<ol>									<li>Attribute already exists</li>								</ol>							</div>';			$output .= '			<form autocomplete="off" method="post" action="'.$url.'" onsubmit="if ($(\'#title\').val() == \'\' || $(\'#system\').val() == \'\') return false">				<input type="hidden" value="'.($id_attribute ? $id_attribute : 'new').'" name="edit_attribute">				<input type="hidden" value="'.$id_group.'" name="id_group">				<input type="hidden" value="'.$attribute['type'].'" name="type">				<fieldset>					<legend>						<img src="../img/admin/tab-customers.gif">						' . (isset($_GET['action']) && $_GET['action'] == 'attr_edit' ? self::l('Edit Attribute') : self::l('Add new Attribute')) . '					</legend>					<label>'.self::l('Title').': <span style="color:red;">*</span></label>					<div class="margin-form">						<input id="title" type="text" value="'.$attribute['title'].'" name="title" size="50">					</div>					<label>'.self::l('Type').': </label>					<div class="margin-form">						<select onchange="selectType(this.value)" '.($id_attribute ? 'disabled' : '').' id="attr_type" name="type" style="width:281px;">							<option value="text">Text</option>							<option value="textarea">Textarea</option>							<option value="file">File (*.zip)</option>							<option value="image">Image (*.jpg, *.png, *.gif)</option>							<option value="select">Select</option>							<option value="multiselect">Multiple select</option>						</select>						<script>							document.getElementById("attr_type").value="'.$attribute['type'].'";							function selectType(f){								if (f == "select" || f == "multiselect"){									$("#selectOptions").show();								} else $("#selectOptions").hide();							}							selectType("'.$attribute['type'].'");							var i = 50000;							function addOption(){								i++;								$("#dop_options").append("<span id=\'op-"+i+"\'>Label: <input size=\'41\' id=\'in-"+i+"\' type=\'text\' name=\'option[new][]\'> <img onclick=\'opHide("+i+")\' src=\'../img/admin/disabled.gif\'><br></span>");							}							function opHide(id){								$("#op-"+id).hide();								$("#in-"+id).val("");							}						</script>							<div id="selectOptions" style="padding:15px;'.((count($options) == 0 || !$options) && ($attribute['type'] != 'select' && $attribute['type'] != 'multiselect') ? 'display:none;' : '').'">								<b>'.self::l('Options').':</b><br>';								foreach ($options ? $options : array() as $option){									$output .= '										<span id="op-'.$option['value_id'].'">											Label: <input id="in-'.$option['value_id'].'" type="text" value="'.$option['value'].'" name="option['.$option['value_id'].']" size="41">											<img onclick="opHide('.$option['value_id'].')" src="../img/admin/disabled.gif"><br>										</span>									';								}								$output .='								<span id="dop_options"></span>								<img style="margin-left:245px;" onclick="addOption()" src="../img/admin/add.gif">							</div>												</div>						<label>'.self::l('System Name:').' <span style="color:red;">*</span></label>					<div class="margin-form">						<input '.($id_attribute ? 'disabled' : '').' id="system" type="text" value="'.$attribute['system'].'" name="system" size="50">					</div>											<label>'.self::l('Sort Order').': </label>					<div class="margin-form">						<input id="title" type="text" value="'.$attribute['sort_order'].'" name="sort_order" size="50">					</div>						<label>'.self::l('Active').': </label>					<div class="margin-form">						<input type="radio" '.($attribute['enable'] == '0' ? 'checked' : empty($attribute['enable']) ? 'checked' : '' ).' value="0" name="enable"> Yes						<input type="radio" '.($attribute['enable'] == '1' ? 'checked' : '' ).' value="1" name="enable"> No					</div>											<div class="margin-form space">						<input class="button" onclick="location.href=\''.$url.'&action=list_attr&id_group='.$id_group.'\'" type="button" value=" '.self::l('Back').' "><input class="button" type="submit" name="submitAddcms" value=" '.self::l('Save').' ">					</div>				</fieldset>			</form>			';					return $output;	}	}